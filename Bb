import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.mongodb.BasicDBObject;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Predicate;

public class ConditionalJsonParser {

    public static void main(String[] args) throws IOException {
        // Example JSON input
        String jsonString = "{ \"root\": { \"payload\": { \"BCSettlementTransaction\": { \"originatingSource\": { \"system\": { \"id\": [ { \"type\": \"otherType\", \"value\": \"12345\" }, { \"type\": \"bcPublisherSystem\", \"value\": \"67890\" } ], \"name\": \"SystemNameExample\" } }, \"transactionDetails\": { \"transactionId\": \"txn123456\", \"amount\": 1000 } } } } }";

        // Define field mappings with conditions
        Map<String, FieldConfig> fieldConfigs = new HashMap<>();
        fieldConfigs.put("systemId", new FieldConfig(
            "/root/payload/BCSettlementTransaction/originatingSource/system/id",
            node -> "bcPublisherSystem".equals(node.get("type").asText()),  // Condition: type == "bcPublisherSystem"
            "value"  // Field to extract if condition is met
        ));
        
        fieldConfigs.put("transactionId", new FieldConfig(
            "/root/payload/BCSettlementTransaction/transactionDetails/transactionId",
            null,  // No condition for a simple field
            null
        ));
        
        fieldConfigs.put("amount", new FieldConfig(
            "/root/payload/BCSettlementTransaction/transactionDetails/amount",
            null,  // No condition for a simple field
            null
        ));
        
        BasicDBObject basicDBObject = extractFieldsWithConditions(jsonString, fieldConfigs);
        
        System.out.println("Resulting BasicDBObject: " + basicDBObject);
    }

    private static BasicDBObject extractFieldsWithConditions(String jsonString, Map<String, FieldConfig> fieldConfigs) throws IOException {
        BasicDBObject basicDBObject = new BasicDBObject();
        ObjectMapper objectMapper = new ObjectMapper();
        JsonNode rootNode = objectMapper.readTree(jsonString);

        for (Map.Entry<String, FieldConfig> entry : fieldConfigs.entrySet()) {
            String fieldName = entry.getKey();
            FieldConfig config = entry.getValue();

            // Traverse JSON based on the path specified in FieldConfig
            JsonNode node = rootNode.at(config.jsonPath.replace("/", "/"));

            // Check if the node is found and apply the condition if present
            if (!node.isMissingNode()) {
                if (node.isArray()) {
                    for (JsonNode item : node) {
                        if (config.condition == null || config.condition.test(item)) {
                            basicDBObject.put(fieldName, config.subField != null ? item.get(config.subField).asText() : item.asText());
                            break;
                        }
                    }
                } else {
                    basicDBObject.put(fieldName, config.subField != null ? node.get(config.subField).asText() : node.asText());
                }
            }
        }
        return basicDBObject;
    }

    // Helper class to store each field's JSON path, condition, and target subfield
    static class FieldConfig {
        String jsonPath;
        Predicate<JsonNode> condition;
        String subField; // the field within a matched node to extract

        public FieldConfig(String jsonPath, Predicate<JsonNode> condition, String subField) {
            this.jsonPath = jsonPath;
            this.condition = condition;
            this.subField = subField;
        }
    }
}
