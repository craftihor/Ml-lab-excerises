package com.example.xmlparser.service;

import com.example.xmlparser.model.*;
import jakarta.xml.bind.JAXBContext;
import jakarta.xml.bind.Unmarshaller;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@Service
public class XmlToCsvService {

    @Value("${xml.file.path}")
    private String xmlFilePath;

    @Value("${csv.output.path}")
    private String csvOutputPath;

    public void convertXmlToCsv() throws Exception {
        SecLendCommissRep secLendCommissRep = loadXmlDocument();
        List<String> headers = getHeaders();

        try (FileWriter writer = new FileWriter(csvOutputPath)) {
            // Write headers
            writer.write(String.join("|", headers) + "\n");

            // Write data
            SecLendCommissSection section = secLendCommissRep.getSecLendCommissRepInfo().getSecLendCommissSection();
            SecInstr secInstr = section.getSecInstr();
            
            for (SecLendCommissDetl detl : section.getSecLendCommissDetl()) {
                List<String> rowData = new ArrayList<>();
                
                // Add common data
                rowData.add(secLendCommissRep.getTmstmp()); // businessDate
                rowData.add(detl.getLoanRef()); // tradeTicket
                rowData.add(""); // tradeTag (empty as not in XML)
                rowData.add(detl.getExtRef()); // external TradeID
                rowData.add(detl.getLoanTyp()); // activityType
                rowData.add(detl.getLenBorrInd()); // buyOrSell
                rowData.add(detl.getLoanOpngDt()); // tradeDate
                rowData.add(detl.getLoanClsgDt()); // valueDate
                rowData.add(secInstr.getIsinCd()); // ISIN
                rowData.add(secInstr.getInstrTyp()); // instrument Type
                rowData.add(secInstr.getSecNm()); // securityName
                rowData.add(String.valueOf(detl.getLoanQty().getValue())); // nominalAmount
                rowData.add(String.valueOf(detl.getLoanVal().getValue())); // netConsiderationoutstanding
                rowData.add(detl.getLoanVal().getIsoCurrCd()); // currency
                rowData.add(String.valueOf(detl.getBondPrcAccrInt())); // bondAccural Interest
                rowData.add(detl.getXchgRate().getFrstIsoCurrCd()); // firstCurrency
                rowData.add(detl.getXchgRate().getRecpIsoCurrCd()); // SecondCurrency
                rowData.add(String.valueOf(detl.getXchgRate().getValue())); // exchangeRate
                rowData.add(String.valueOf(detl.getFeeRate())); // feeRate
                rowData.add(String.valueOf(detl.getDivCoupReq())); // dividendCoupon
                rowData.add(String.valueOf(detl.getHdlgFeeAmnt().getValue())); // handling Fee
                rowData.add(detl.getHdlgFeeAmnt().getIsoCurrCd()); // handlingCurrency
                rowData.add(String.valueOf(detl.getCurntCommissAmnt().getValue())); // commissionAmount
                rowData.add(detl.getCurntCommissAmnt().getIsoCurrCd()); // commissionCurrency
                rowData.add(String.valueOf(detl.getAccrCommissAmnt().getValue())); // accuralCommissionAmount
                rowData.add(detl.getAccrCommissAmnt().getIsoCurrCd()); // accuralCommissionCurrency
                rowData.add(String.valueOf(detl.getCollPldgMrktVal().getValue())); // pledgedCollateralvalue
                rowData.add(detl.getCollPldgMrktVal().getIsoCurrCd()); // pledgedCollateralCurrency
                rowData.add(String.valueOf(detl.getCollPldgFeeRate())); // pledgedCollateralFee
                rowData.add(String.valueOf(detl.getCollPldgCurntCommissAmnt().getValue())); // pledged CollateralCurrent Amount
                rowData.add(detl.getCollPldgCurntCommissAmnt().getIsoCurrCd()); // pledgedCollateral CurrentCurrency
                rowData.add(String.valueOf(detl.getCollPldgAccrCommissAmnt().getValue())); // pledgedCollateralAccuralAmount
                rowData.add(detl.getCollPldgAccrCommissAmnt().getIsoCurrCd()); // pledgedCollateralAccuralCurrency
                rowData.add(detl.getCurntCommissStartDt()); // comissionStartDate
                rowData.add(detl.getCurntCommissEndDt()); // comissionEndDate
                rowData.add(secLendCommissRep.getAcct().getAcctId()); // settlement Depot ID
                rowData.add(secLendCommissRep.getAcct().getAcctNm()); // settlement DepotAccount
                rowData.add(""); // Root Cause (empty as not in XML)
                rowData.add(""); // Commentary (empty as not in XML)
                rowData.add("AUTO BORROW"); // Message Type (hardcoded)

                writer.write(String.join("|", rowData) + "\n");
            }
        }
    }

    private SecLendCommissRep loadXmlDocument() throws Exception {
        JAXBContext jaxbContext = JAXBContext.newInstance(SecLendCommissRep.class);
        Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();
        return (SecLendCommissRep) unmarshaller.unmarshal(new File(xmlFilePath));
    }

    private List<String> getHeaders() {
        List<String> headers = new ArrayList<>();
        headers.add("businessDate");
        headers.add("tradeTicket");
        headers.add("tradeTag");
        headers.add("externalTradeID");
        headers.add("activityType");
        headers.add("buyOrSell");
        headers.add("tradeDate");
        headers.add("valueDate");
        headers.add("ISIN");
        headers.add("instrumentType");
        headers.add("securityName");
        headers.add("nominalAmount");
        headers.add("netConsiderationoutstanding");
        headers.add("currency");
        headers.add("bondAccuralInterest");
        headers.add("firstCurrency");
        headers.add("SecondCurrency");
        headers.add("exchangeRate");
        headers.add("feeRate");
        headers.add("dividendCoupon");
        headers.add("handlingFee");
        headers.add("handlingCurrency");
        headers.add("commissionAmount");
        headers.add("commissionCurrency");
        headers.add("accuralCommissionAmount");
        headers.add("accuralCommissionCurrency");
        headers.add("pledgedCollateralvalue");
        headers.add("pledgedCollateralCurrency");
        headers.add("pledgedCollateralFee");
        headers.add("pledgedCollateralCurrentAmount");
        headers.add("pledgedCollateralCurrentCurrency");
        headers.add("pledgedCollateralAccuralAmount");
        headers.add("pledgedCollateralAccuralCurrency");
        headers.add("comissionStartDate");
        headers.add("comissionEndDate");
        headers.add("settlementDepotID");
        headers.add("settlementDepotAccount");
        headers.add("RootCause");
        headers.add("Commentary");
        headers.add("MessageType");
        return headers;
    }
}
